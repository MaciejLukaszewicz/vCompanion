<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}vCompanion{% endblock %}</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>
    {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside>
        <div class="logo">
            <i data-lucide="shield-check" style="stroke-width: 3px;"></i>
            vCompanion
        </div>
        <nav>
            <ul>
                <li><a href="/" class="{% if active_page == 'dashboard' %}active{% endif %}">
                        <i data-lucide="layout-dashboard"></i> Dashboard
                    </a></li>
                <li><a href="/inventory" class="{% if active_page == 'inventory' %}active{% endif %}">
                        <i data-lucide="layers"></i> Inventory
                    </a></li>
                <li><a href="/datastores" class="{% if active_page == 'datastores' %}active{% endif %}">
                        <i data-lucide="database"></i> Datastores
                    </a></li>
                <li><a href="/hosts" class="{% if active_page == 'hosts' %}active{% endif %}">
                        <i data-lucide="server"></i> Hosts
                    </a></li>
                <li><a href="/performance" class="{% if active_page == 'performance' %}active{% endif %}">
                        <i data-lucide="activity"></i> Performance
                    </a></li>
                <li><a href="/reports" class="{% if active_page == 'reports' %}active{% endif %}">
                        <i data-lucide="file-text"></i> Reports
                    </a></li>
                <li><a href="/settings" class="{% if active_page == 'settings' %}active{% endif %}">
                        <i data-lucide="settings"></i> Settings
                    </a></li>
            </ul>
        </nav>

        <!-- User info at bottom of sidebar -->
        {% if username %}
        <div class="sidebar-footer">
            <div class="user-info">
                <i data-lucide="user"></i>
                <span>{{ username }}</span>
            </div>
            <form method="POST" action="/api/auth/logout">
                <button type="submit" class="btn-logout-sidebar">
                    <i data-lucide="log-out"></i>
                </button>
            </form>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content Area -->
    <main>
        <!-- vCenter Status Bar -->
        {% if vcenter_status %}
        <div class="vcenter-status-bar">
            <div class="vcenter-status-container" hx-get="/api/vcenters/status-bar" hx-trigger="every 5s"
                hx-swap="innerHTML">
                {% include "partials/vcenter_status_bar.html" %}
            </div>

            <div class="vcenter-actions">
                <button class="btn-refresh-all" hx-post="/api/vcenters/refresh-all" hx-swap="none"
                    title="Refresh all connected vCenters">
                    <i data-lucide="refresh-cw"></i>
                    Refresh All
                </button>
            </div>
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container"
        style="position: fixed; bottom: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem;">
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoginModal()">&times;</span>
            <h2>Connect to vCenter Servers</h2>
            <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                Log in to additional vCenter servers. Your existing connections will remain active.
            </p>

            <form id="additionalLoginForm">
                <div class="form-group">
                    <label for="modal-username">
                        <i data-lucide="user"></i>
                        Username
                    </label>
                    <input type="text" id="modal-username" placeholder="vCenter username" required>
                </div>

                <div class="form-group">
                    <label for="modal-password">
                        <i data-lucide="lock"></i>
                        Password
                    </label>
                    <input type="password" id="modal-password" placeholder="vCenter password" required>
                </div>

                <div class="form-group">
                    <label style="margin-bottom: 0.75rem; display: block;">
                        <i data-lucide="server"></i>
                        Select Disconnected vCenters
                    </label>
                    <div class="vcenter-list" id="modalVcenterList">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <div id="modalError" class="alert alert-error" style="display: none;">
                    <i data-lucide="alert-circle"></i>
                    <span id="modalErrorText"></span>
                </div>

                <div id="modalSuccess" class="alert alert-success" style="display: none;">
                    <i data-lucide="check-circle"></i>
                    <span id="modalSuccessText"></span>
                </div>

                <button type="submit" class="btn-primary">
                    <i data-lucide="log-in"></i>
                    Connect
                </button>
            </form>
        </div>
    </div>

    <script>
        // Modal functions
        function openLoginModal(preselectedVcId = null) {
            const modal = document.getElementById('loginModal');
            const vcenterList = document.getElementById('modalVcenterList');

            // Clear previous content
            vcenterList.innerHTML = '';

            // Get disconnected vCenters from status bar
            const disconnectedVCs = Array.from(document.querySelectorAll('.vcenter-pill.disconnected'));

            if (disconnectedVCs.length === 0) {
                vcenterList.innerHTML = '<p style="color: var(--text-dim); font-style: italic;">All vCenters are already connected.</p>';
            } else {
                disconnectedVCs.forEach(pill => {
                    const vcId = pill.getAttribute('data-vcenter-id');
                    const vcName = pill.querySelector('.vcenter-name').textContent;

                    const checkbox = document.createElement('div');
                    checkbox.className = 'vcenter-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="modal_vc_${vcId}" value="${vcId}" ${preselectedVcId === vcId ? 'checked' : ''}>
                        <label for="modal_vc_${vcId}">
                            <strong>${vcName}</strong>
                        </label>
                    `;
                    vcenterList.appendChild(checkbox);
                });
            }

            // Clear form
            document.getElementById('modal-username').value = '';
            document.getElementById('modal-password').value = '';
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalSuccess').style.display = 'none';

            modal.style.display = 'flex';
            refreshIcons();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('loginModal');
            if (event.target === modal) {
                closeLoginModal();
            }
        }

        // Handle additional login form submission
        document.getElementById('additionalLoginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('modal-username').value;
            const password = document.getElementById('modal-password').value;

            // Collect selected vCenter IDs
            const checkboxes = document.querySelectorAll('#modalVcenterList input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                showModalError('Please select at least one vCenter server.');
                return;
            }

            // Hide previous messages
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalSuccess').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('selected_vcenters', selectedIds.join(','));

                const response = await fetch('/api/auth/login-additional', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showModalSuccess(`Successfully connected to ${data.connected.length} vCenter(s)!`);

                    // Wait a moment then reload page to refresh status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showModalError(data.error || 'Failed to connect to selected vCenters.');
                }

            } catch (error) {
                showModalError('An error occurred: ' + error.message);
            }
        });

        function showModalError(message) {
            const errorDiv = document.getElementById('modalError');
            document.getElementById('modalErrorText').textContent = message;
            errorDiv.style.display = 'flex';
            refreshIcons();
        }

        function showModalSuccess(message) {
            const successDiv = document.getElementById('modalSuccess');
            document.getElementById('modalSuccessText').textContent = message;
            successDiv.style.display = 'flex';
            refreshIcons();
        }
        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshIcons();
            setTimeout(refreshIcons, 100);
            setTimeout(refreshIcons, 500); // Extra safety
        });

        // Refresh icons after HTMX content updates
        document.body.addEventListener('htmx:afterOnLoad', refreshIcons);

        // Toast Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = {
                'info': 'var(--primary)',
                'error': 'var(--danger)',
                'warning': 'var(--warning)',
                'success': 'var(--success)'
            };

            const icons = {
                'info': 'info',
                'error': 'alert-circle',
                'warning': 'alert-triangle',
                'success': 'check-circle'
            };

            toast.style.cssText = `
                background: var(--surface);
                border-left: 4px solid ${colors[type]};
                color: var(--text-main);
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.4);
                display: flex;
                align-items: center;
                gap: 1rem;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            `;

            toast.innerHTML = `
                <i data-lucide="${icons[type]}" style="color: ${colors[type]}"></i>
                <span style="font-weight: 500;">${message}</span>
            `;

            container.appendChild(toast);
            refreshIcons();

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        const styles = document.createElement('style');
        styles.innerHTML = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styles);

        window.showNotification = showNotification;
    </script>
    {% block extra_scripts %} {% endblock %}
</body>

</html>