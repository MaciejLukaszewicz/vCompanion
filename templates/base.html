<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ settings.app_settings.title }}{% endblock %}</title>
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>
    {% block extra_head %}{% endblock %}
</head>

<body class="theme-{{ settings.app_settings.theme }} accent-{{ settings.app_settings.accent_color }}">
    <script>
        if (document.cookie.includes('sidebarCollapsed=true')) {
            document.body.classList.add('sidebar-collapsed');
        }
    </script>
    <!-- Sidebar Navigation -->
    <aside id="sidebar">
        <script>
            if (document.cookie.includes('sidebarCollapsed=true')) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        </script>
        <div class="sidebar-header">
            <div class="logo">
                <i data-lucide="shield-check" style="stroke-width: 3px;"></i>
                <span class="logo-text">{{ settings.app_settings.title }}</span>
            </div>
            <div class="sidebar-actions">
                <button id="sidebar-toggle" class="btn-sidebar-action" title="Toggle Sidebar">
                    <i data-lucide="chevron-left"></i>
                </button>
            </div>
        </div>
        <nav hx-boost="true" hx-target="#page-content" hx-select="#page-content" hx-swap="outerHTML" hx-push-url="true">
            <ul>
                <li><a href="/" class="{% if active_page == 'dashboard' %}active{% endif %}" title="Dashboard">
                        <i data-lucide="layout-dashboard"></i>
                        <span class="nav-text">Dashboard</span>
                    </a></li>
                <li><a href="/inventory" class="{% if active_page == 'inventory' %}active{% endif %}" title="Inventory">
                        <i data-lucide="layers"></i>
                        <span class="nav-text">Inventory</span>
                    </a></li>
                <li><a href="/performance" class="{% if active_page == 'performance' %}active{% endif %}"
                        title="Performance">
                        <i data-lucide="activity"></i>
                        <span class="nav-text">Performance</span>
                    </a></li>
                <li><a href="/settings" class="{% if active_page == 'settings' %}active{% endif %}" title="Settings">
                        <i data-lucide="settings"></i>
                        <span class="nav-text">Settings</span>
                    </a></li>
            </ul>
        </nav>

        <!-- User info at bottom of sidebar -->
        {% if username %}
        <div class="sidebar-footer">
            <div class="user-info">
                <i data-lucide="user"></i>
                <span class="user-name">{{ username }}</span>
            </div>
            <form method="POST" action="/api/auth/logout">
                <button type="submit" class="btn-logout-sidebar" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </form>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content Area -->
    <main>
        <!-- vCenter Status Bar -->
        {% if vcenter_status %}
        <div class="vcenter-status-bar">
            <div class="vcenter-status-container" hx-get="/api/vcenters/status-bar" hx-trigger="every 5s"
                hx-swap="innerHTML">
                {% include "partials/vcenter_status_bar.html" %}
            </div>

            <div class="vcenter-actions">
                <div id="session-timer"
                    style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(var(--primary-rgb), 0.1); border-radius: 6px; font-size: 0.85rem; color: var(--text-dim);">
                    <i data-lucide="clock" size="16"></i>
                    <span id="session-time-remaining">--:--</span>
                </div>
                <button class="btn-refresh-all" hx-post="/api/vcenters/refresh-all" hx-swap="none"
                    title="Refresh all connected vCenters">
                    <i data-lucide="refresh-cw"></i>
                    Refresh All
                </button>
            </div>
        </div>
        {% endif %}

        <div id="page-content">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container"
        style="position: fixed; bottom: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem;">
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoginModal()">&times;</span>
            <h2>Connect to vCenter Servers</h2>
            <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                Log in to additional vCenter servers. Your existing connections will remain active.
            </p>

            <form id="additionalLoginForm">
                <div class="form-group">
                    <label for="modal-username">
                        <i data-lucide="user"></i>
                        Username
                    </label>
                    <input type="text" id="modal-username" placeholder="vCenter username" required>
                </div>

                <div class="form-group">
                    <label for="modal-password">
                        <i data-lucide="lock"></i>
                        Password
                    </label>
                    <input type="password" id="modal-password" placeholder="vCenter password" required>
                </div>

                <div class="form-group">
                    <label style="margin-bottom: 0.75rem; display: block;">
                        <i data-lucide="server"></i>
                        Select Disconnected vCenters
                    </label>
                    <div class="vcenter-list" id="modalVcenterList">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <div id="modalError" class="alert alert-error" style="display: none;">
                    <i data-lucide="alert-circle"></i>
                    <span id="modalErrorText"></span>
                </div>

                <div id="modalSuccess" class="alert alert-success" style="display: none;">
                    <i data-lucide="check-circle"></i>
                    <span id="modalSuccessText"></span>
                </div>

                <button type="submit" class="btn-primary">
                    <i data-lucide="log-in"></i>
                    Connect
                </button>
            </form>
        </div>
    </div>

    <!-- Connection Lost Overlay -->
    <div id="connection-lost-overlay" class="connection-lost-overlay" style="display: none;">
        <div class="login-card" style="max-width: 500px; width: 90%; text-align: center;">
            <div class="server-unavailable-state" style="margin-top: 0; border: none; background: transparent;">
                <i data-lucide="cloud-off" style="width: 64px; height: 64px;"></i>
                <h2 style="font-size: 2rem;">Connection Lost</h2>
                <p style="font-size: 1.125rem;">The vCompanion server is currently unreachable.<br>Attempting to
                    reconnect automatically...</p>
                <div class="spinner-small"
                    style="margin-top: 2rem; width: 30px; height: 30px; border-width: 3px; margin-left: auto; margin-right: auto;">
                </div>

                <button onclick="window.location.reload()" class="btn-primary"
                    style="margin-top: 2rem; width: auto; padding: 0.75rem 2rem; margin-left: auto; margin-right: auto;">
                    <i data-lucide="refresh-cw"></i> Retry Now
                </button>
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        function openLoginModal(preselectedVcId = null) {
            const modal = document.getElementById('loginModal');
            const vcenterList = document.getElementById('modalVcenterList');

            // Clear previous content
            vcenterList.innerHTML = '';

            // Get disconnected vCenters from status bar
            const disconnectedVCs = Array.from(document.querySelectorAll('.vcenter-pill.disconnected'));

            if (disconnectedVCs.length === 0) {
                vcenterList.innerHTML = '<p style="color: var(--text-dim); font-style: italic;">All vCenters are already connected.</p>';
            } else {
                disconnectedVCs.forEach(pill => {
                    const vcId = pill.getAttribute('data-vcenter-id');
                    const vcName = pill.querySelector('.vcenter-name').textContent;

                    const checkbox = document.createElement('div');
                    checkbox.className = 'vcenter-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="modal_vc_${vcId}" value="${vcId}" ${preselectedVcId === vcId ? 'checked' : ''}>
                        <label for="modal_vc_${vcId}">
                            <strong>${vcName}</strong>
                        </label>
                    `;
                    vcenterList.appendChild(checkbox);
                });
            }

            // Clear form
            document.getElementById('modal-username').value = '';
            document.getElementById('modal-password').value = '';
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalSuccess').style.display = 'none';

            modal.style.display = 'flex';
            refreshIcons();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('loginModal');
            if (event.target === modal) {
                closeLoginModal();
            }
        }

        // Handle additional login form submission
        document.getElementById('additionalLoginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('modal-username').value;
            const password = document.getElementById('modal-password').value;

            // Collect selected vCenter IDs
            const checkboxes = document.querySelectorAll('#modalVcenterList input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                showModalError('Please select at least one vCenter server.');
                return;
            }

            // Hide previous messages
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalSuccess').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('selected_vcenters', selectedIds.join(','));

                const response = await fetch('/api/auth/login-additional', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showModalSuccess(`Successfully connected to ${data.connected.length} vCenter(s)!`);

                    // Wait a moment then reload page to refresh status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showModalError(data.error || 'Failed to connect to selected vCenters.');
                }

            } catch (error) {
                showModalError('An error occurred: ' + error.message);
            }
        });

        function showModalError(message) {
            const errorDiv = document.getElementById('modalError');
            document.getElementById('modalErrorText').textContent = message;
            errorDiv.style.display = 'flex';
            refreshIcons();
        }

        function showModalSuccess(message) {
            const successDiv = document.getElementById('modalSuccess');
            document.getElementById('modalSuccessText').textContent = message;
            successDiv.style.display = 'flex';
            refreshIcons();
        }
        function refreshIcons(target = document.body) {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons({
                    root: target
                });
            }
        }

        // Sidebar Toggle Logic
        (function () {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const body = document.body;

            // Helper to get cookie
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            // Helper to set cookie
            function setCookie(name, value, days) {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (value || "") + expires + "; path=/";
            }

            // Load saved state from cookie
            let isCollapsed = getCookie('sidebarCollapsed') === 'true';

            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                body.classList.add('sidebar-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-right"></i>';
            } else {
                sidebar.classList.remove('collapsed');
                body.classList.remove('sidebar-collapsed');
                toggleBtn.innerHTML = '<i data-lucide="chevron-left"></i>';
            }

            toggleBtn.addEventListener('click', () => {
                const currentlyCollapsed = body.classList.contains('sidebar-collapsed');
                if (currentlyCollapsed) {
                    sidebar.classList.remove('collapsed');
                    body.classList.remove('sidebar-collapsed');
                    toggleBtn.innerHTML = '<i data-lucide="chevron-left"></i>';
                    setCookie('sidebarCollapsed', 'false', 365);
                } else {
                    sidebar.classList.add('collapsed');
                    body.classList.add('sidebar-collapsed');
                    toggleBtn.innerHTML = '<i data-lucide="chevron-right"></i>';
                    setCookie('sidebarCollapsed', 'true', 365);
                }
                refreshIcons(toggleBtn);
            });
        })();

        document.addEventListener('DOMContentLoaded', () => {
            refreshIcons();
        });

        // Optimize: Refresh icons ONLY in the updated part of the DOM
        document.body.addEventListener('htmx:afterOnLoad', (evt) => {
            if (evt.detail.target) {
                refreshIcons(evt.detail.target);
            }
            // Update active state in sidebar seamlessly
            if (evt.detail.target && evt.detail.target.id === 'page-content') {
                const url = new URL(evt.detail.xhr.responseURL).pathname;
                document.querySelectorAll('nav a').forEach(a => {
                    if (a.getAttribute('href') === url) {
                        a.classList.add('active');
                    } else {
                        a.classList.remove('active');
                    }
                });
            }
        });

        // Server Health Monitoring
        let isDisconnected = false;
        let reconnectInterval = null;
        window.isRestartingServer = false;

        document.body.addEventListener('htmx:sendError', function (evt) {
            if (window.isRestartingServer) return;
            handleDisconnect();
        });

        document.body.addEventListener('htmx:responseError', function (evt) {
            if (window.isRestartingServer) return;
            if (evt.detail.xhr.status === 0 || evt.detail.xhr.status >= 500) {
                // Status 0 means server is down/network error
                handleDisconnect();
            }
        });

        async function checkServerHealth() {
            if (window.isRestartingServer) return;
            try {
                const response = await fetch('/api/health');
                if (response.ok || response.status === 401) { // 401 is fine, means server is up but session expired
                    handleReconnect();
                }
            } catch (e) {
                // Still down
            }
        }

        function handleDisconnect() {
            if (isDisconnected) return;
            isDisconnected = true;
            document.getElementById('connection-lost-overlay').style.display = 'flex';

            // Start polling for server to come back
            if (!reconnectInterval) {
                reconnectInterval = setInterval(checkServerHealth, 3000);
            }

            if (window.showNotification) {
                showNotification("Server connection lost!", "error");
            }
        }

        function handleReconnect() {
            if (!isDisconnected) return;
            isDisconnected = false;
            document.getElementById('connection-lost-overlay').style.display = 'none';

            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }

            if (window.showNotification) {
                showNotification("Connection restored.", "success");
            }

            // Trigger a full refresh of UI components
            htmx.trigger("body", "vcenter-refreshed");
        }

        // Toast Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const colors = {
                'info': 'var(--primary)',
                'error': 'var(--danger)',
                'warning': 'var(--warning)',
                'success': 'var(--success)'
            };

            const icons = {
                'info': 'info',
                'error': 'alert-circle',
                'warning': 'alert-triangle',
                'success': 'check-circle'
            };

            toast.style.cssText = `
                background: var(--surface);
                border-left: 4px solid ${colors[type]};
                color: var(--text-main);
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.4);
                display: flex;
                align-items: center;
                gap: 1rem;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            `;

            toast.innerHTML = `
                <i data-lucide="${icons[type]}" style="color: ${colors[type]}"></i>
                <span style="font-weight: 500;">${message}</span>
            `;

            container.appendChild(toast);
            refreshIcons();

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        const styles = document.createElement('style');
        styles.innerHTML = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styles);

        window.showNotification = showNotification;

        // Session timeout countdown
        {% if username %}
        (function () {
            const SESSION_TIMEOUT = parseInt("{{ settings.app_settings.session_timeout }}", 10);
            const WARNING_THRESHOLD = 300; // 5 minutes warning
            let sessionStartTime = Date.now();

            // Try to get last activity from sessionStorage
            const lastActivity = sessionStorage.getItem('lastActivity');
            if (lastActivity) {
                sessionStartTime = parseInt(lastActivity);
            } else {
                sessionStorage.setItem('lastActivity', sessionStartTime.toString());
            }

            function updateSessionTimer() {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const remaining = Math.max(0, SESSION_TIMEOUT - elapsed);

                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;

                const timerElement = document.getElementById('session-time-remaining');
                if (timerElement) {
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                    const timerContainer = document.getElementById('session-timer');
                    if (timerContainer) {
                        // Change color based on remaining time
                        if (remaining <= 60) {
                            timerContainer.style.background = 'rgba(239, 68, 68, 0.2)';
                            timerContainer.style.color = 'var(--danger)';
                        } else if (remaining <= WARNING_THRESHOLD) {
                            timerContainer.style.background = 'rgba(245, 158, 11, 0.2)';
                            timerContainer.style.color = 'var(--warning)';
                        } else {
                            timerContainer.style.background = 'rgba(var(--primary-rgb), 0.1)';
                            timerContainer.style.color = 'var(--text-dim)';
                        }
                    }
                }

                // Redirect to login when session expires
                if (remaining <= 0) {
                    sessionStorage.removeItem('lastActivity');
                    window.location.href = '/login';
                }
            }

            // Update every second
            setInterval(updateSessionTimer, 1000);
            updateSessionTimer();

            // Reset timer on user activity
            const resetTimer = () => {
                sessionStartTime = Date.now();
                sessionStorage.setItem('lastActivity', sessionStartTime.toString());
            };

            // Listen for user activity
            ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimer, { passive: true });
            });
        })();
        {% endif %}
    </script>
    {% block extra_scripts %} {% endblock %}
</body>

</html>