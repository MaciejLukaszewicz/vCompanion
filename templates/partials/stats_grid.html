<div class="stat-card">
    <h3>Total Virtual Machines</h3>
    <div class="value">{{ stats.total_vms | default('--') }}</div>
    <div style="font-size: 0.875rem; color: var(--text-dim); margin-top: 0.5rem;">{{ stats.vms_delta |
        default('Loading...') }}</div>

    {% if per_vcenter_stats %}
    <div class="stat-breakdown">
        {% for vc_id, vc in per_vcenter_stats.items() %}
        <div class="breakdown-item">
            <span>{{ vc.name }}</span>
            <strong>{{ vc.vms }}</strong>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="stat-card">
    <h3>Active Snapshots</h3>
    <div class="value">{{ stats.snapshots | default('--') }}</div>
    <div style="font-size: 0.875rem; color: var(--text-dim); margin-top: 0.5rem;">{{ stats.snapshots_delta |
        default('Loading...') }}</div>

    {% if per_vcenter_stats %}
    <div class="stat-breakdown">
        {% for vc_id, vc in per_vcenter_stats.items() %}
        <div class="breakdown-item">
            <span>{{ vc.name }}</span>
            <strong>{{ vc.snapshots }}</strong>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="stat-card">
    <h3>Host Systems</h3>
    <div class="value">{{ stats.clusters | default('--') }}</div>
    <div style="font-size: 0.875rem; color: var(--text-dim); margin-top: 0.5rem;">{{ stats.clusters_status |
        default('Loading...') }}</div>

    {% if per_vcenter_stats %}
    <div class="stat-breakdown">
        {% for vc_id, vc in per_vcenter_stats.items() %}
        <div class="breakdown-item">
            <span>{{ vc.name }}</span>
            <strong>{{ vc.hosts }}</strong>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="stat-card alert-card">
    <h3>Infrastructure Alerts</h3>
    <div class="alert-severity-list">
        <div class="alert-severity-item severity-crit">
            <i data-lucide="alert-circle" size="20"></i>
            <span style="font-size: 1.75rem;">{{ stats.critical_alerts | default('0') }}</span>
            <span style="font-size: 0.75rem; opacity: 0.8;">Critical</span>
        </div>
        <div class="alert-severity-item severity-warn" style="margin-left: 1.5rem;">
            <i data-lucide="alert-triangle" size="20"></i>
            <span style="font-size: 1.75rem;">{{ stats.warning_alerts | default('0') }}</span>
            <span style="font-size: 0.75rem; opacity: 0.8;">Warning</span>
        </div>
    </div>

    {% if per_vcenter_stats %}
    <div class="stat-breakdown" style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
        {% for vc_id, vc in per_vcenter_stats.items() %}
        <div class="breakdown-item"
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 0.25rem;">
            <span style="font-size: 0.75rem;">{{ vc.name }}</span>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <span class="severity-crit" style="font-weight: 700;">{{ vc.critical }}</span>
                    <span style="font-size: 0.65rem; color: var(--text-dim);">CRIT</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <span class="severity-warn" style="font-weight: 700;">{{ vc.warning }}</span>
                    <span style="font-size: 0.65rem; color: var(--text-dim);">WARN</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Alert Change Notification Logic
    (function () {
        const currentCrit = parseInt('{{ stats.critical_alerts | default(0) }}');
        const currentWarn = parseInt('{{ stats.warning_alerts | default(0) }}');

        const lastCrit = parseInt(localStorage.getItem('vcompanion_last_crit') || '-1');
        const lastWarn = parseInt(localStorage.getItem('vcompanion_last_warn') || '-1');

        if (lastCrit !== -1 && (currentCrit !== lastCrit || currentWarn !== lastWarn)) {
            // Show notification if bridged
            if (window.showNotification) {
                let msg = "";
                if (currentCrit > lastCrit) msg = `New CRITICAL alerts detected! (${currentCrit})`;
                else if (currentCrit < lastCrit) msg = `Critical alerts resolved. (${currentCrit} remaining)`;
                else msg = `Alert status updated.`;

                window.showNotification(msg, currentCrit > lastCrit ? 'error' : 'info');
            }
        }

        localStorage.setItem('vcompanion_last_crit', currentCrit);
        localStorage.setItem('vcompanion_last_warn', currentWarn);
    })();
</script>