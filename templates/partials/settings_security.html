{% if success_msg %}
<div class="alert alert-success" style="margin-bottom: 1.5rem;">
    <i data-lucide="check-circle"></i>
    {{ success_msg }}
</div>
{% endif %}

<div style="display: flex; flex-direction: column; gap: 3rem;">
    <!-- Session Section -->
    <section>
        <h3 style="font-size: 1rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="clock" size="18"></i> Session Management
        </h3>
        <form hx-post="/api/settings/security/update" hx-target="#settings-content-area" class="vcompanion-form">
            <div class="form-group" style="max-width: 400px;">
                <label><i data-lucide="timer" size="16"></i> Session Inactivity Timeout (seconds)</label>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="number" name="session_timeout" value="{{ app_settings.session_timeout }}" min="60"
                        required>
                    <span style="color: var(--text-dim); white-space: nowrap;">
                        ({{ (app_settings.session_timeout / 60)|round|int }} min)
                    </span>
                </div>
                <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">
                    The duration of inactivity before the user is automatically logged out.
                </p>
            </div>
            <div style="margin-top: 1.5rem;">
                <button type="submit" class="btn-primary" style="padding: 0.6rem 1.25rem; font-size: 0.875rem;">
                    <i data-lucide="save"></i> Update Session Timeout
                </button>
            </div>
        </form>
        <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>
    </section>

    <!-- Elevated Privileges Section -->
    <section style="padding-top: 2rem; border-top: 1px solid var(--border);">
        <h3 style="font-size: 1rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="shield-check" size="18"></i> Elevated Privileges
        </h3>
        <p style="color: var(--text-dim); font-size: 0.875rem; margin-bottom: 1.5rem;">
            Certain sensitive operations (like toggling SSH or management services) are locked by default to prevent
            accidental changes.
            Unlocking them will enable these controls across the application for the duration of this session only.
        </p>

        <div
            style="background: rgba(var(--primary-rgb), 0.03); border: 1px solid var(--border); padding: 1.25rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 40px; height: 40px; border-radius: 50%; background: {{ 'rgba(34, 197, 94, 0.1)' if elevated_unlocked else 'rgba(239, 68, 68, 0.1)' }}; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="{{ 'shield-check' if elevated_unlocked else 'shield-alert' }}"
                        style="color: {{ 'var(--success)' if elevated_unlocked else 'var(--danger)' }};"></i>
                </div>
                <div>
                    <div style="font-weight: 600; color: var(--text-main);">Unlock elevated privileges options</div>
                    <div style="font-size: 0.75rem; color: var(--text-dim);">
                        Current state: <span
                            style="font-weight: 700; color: {{ 'var(--success)' if elevated_unlocked else 'var(--danger)' }};">
                            {{ 'UNLOCKED' if elevated_unlocked else 'LOCKED' }}
                        </span>
                    </div>
                </div>
            </div>

            <label class="switch">
                <input type="checkbox" id="elevated-toggle" {{ 'checked' if elevated_unlocked }}
                    onchange="toggleElevated(this.checked)">
                <span class="slider round"></span>
            </label>
        </div>

        <script>
            async function toggleElevated(isUnlocked) {
                try {
                    const r = await fetch('/api/settings/security/elevated', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ unlocked: isUnlocked })
                    });
                    const data = await r.json();
                    if (data.success) {
                        // Refresh settings content to reflect state change
                        htmx.trigger('#settings-content-area', 'refresh-security');
                        if (window.showNotification) {
                            window.showNotification(`Elevated privileges ${isUnlocked ? 'unlocked' : 'locked'}.`, isUnlocked ? 'success' : 'warning');
                        }
                    }
                } catch (e) {
                    console.error('Failed to toggle elevated privileges:', e);
                    document.getElementById('elevated-toggle').checked = !isUnlocked;
                }
            }
        </script>
    </section>


    <!-- Data Protection Section -->
    <section style="padding-top: 2rem; border-top: 1px solid var(--border);">
        <h3 style="font-size: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="shield-check" size="18"></i> Data Protection
        </h3>
        <p style="color: var(--text-dim); font-size: 0.875rem; margin-bottom: 1.5rem;">
            vCompanion uses a <strong>Zero-Password-Storage</strong> approach. All vCenter data saved on local disk is
            encrypted using AES-256 (Fernet).
        </p>

        <div class="alert alert-warning"
            style="background: rgba(245, 158, 11, 0.05); border-color: rgba(245, 158, 11, 0.2);">
            <i data-lucide="alert-triangle"></i>
            <div>
                <strong style="display: block; margin-bottom: 0.25rem;">Danger Zone: Encrypted Cache</strong>
                Purging the local cache will permanently delete all encrypted vCenter inventory data. You will need to
                log in again to rebuild the inventory.
            </div>
        </div>

        <button class="btn-primary"
            style="background: transparent; border: 1px solid var(--danger); color: var(--danger);"
            hx-post="/api/settings/security/purge-cache"
            hx-confirm="Are you sure you want to delete ALL encrypted cache files? This cannot be undone and you will be forced to log in again."
            hx-on::after-request="handlePurgeResponse(event)">
            <i data-lucide="trash-2"></i> Purge Local Encrypted Cache
        </button>
    </section>
</div>

<script>
    if (typeof refreshIcons === 'function') refreshIcons();

    async function handlePurgeResponse(event) {
        const response = JSON.parse(event.detail.xhr.response);
        if (response.status === 'ok') {
            await showConfirm({
                title: 'Cache Purged',
                message: response.message,
                confirmLabel: 'Log In Again',
                variant: 'info'
            });
            window.location.href = '/login';
        }
    }
</script>