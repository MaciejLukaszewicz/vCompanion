{% extends "base.html" %}

{% block title %}vCompanion - Inventory{% endblock %}

{% block content %}
<header>
    <div>
        <h1>Infrastructure Inventory</h1>
        <p style="color: var(--text-dim); font-size: 0.875rem;">Manage and explore your virtual infrastructure objects
        </p>
    </div>
</header>

<div class="inventory-container" style="display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1rem;">
    <!-- VMs Section -->
    <section class="table-container" id="vms-section">
        <div
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
            <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
                <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap; cursor: pointer; user-select: none;"
                    onclick="toggleInventorySection('vms-content', 'vms-toggle-icon')">
                    <i data-lucide="monitor" size="18" style="color: var(--primary);"></i> Virtual Machines
                </h2>

                <!-- Filters Bar -->
                <form id="vm-filters"
                    style="display: flex; align-items: center; gap: 1.5rem; flex: 1; max-width: 800px;"
                    hx-get="/api/inventory/vms" hx-target="#vm-list-target"
                    hx-trigger="change, keyup delay:300ms from:#vm-search">

                    <!-- Hidden inputs to preserve selection state -->
                    <input type="hidden" name="selected_vm_id" id="selected-vm-id">
                    <input type="hidden" name="selected_vcenter_id" id="selected-vcenter-id">

                    <!-- Global Search -->
                    <div style="position: relative; flex: 1;">
                        <i data-lucide="search" size="14"
                            style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                        <input type="text" id="vm-search" name="q"
                            placeholder="Search by Name, IP, vCenter, Host, Snapshot..."
                            onfocus="window.isSearchFocused = true" onblur="window.isSearchFocused = false"
                            style="width: 100%; background: var(--bg-main); border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem 2.5rem 0.4rem 2.25rem; font-size: 0.85rem; color: var(--text-main);">
                        <!-- Clear Search Button -->
                        <div id="clear-search" onclick="clearVmSearch()"
                            style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim); cursor: pointer; display: none; padding: 2px;">
                            <i data-lucide="x" size="14"></i>
                        </div>
                    </div>

                    <!-- Snapshots Filter (Styled Switch) -->
                    <label
                        style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;">
                        <div class="switch">
                            <input type="checkbox" name="snaps_only" value="true" hx-trigger="change">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size: 0.85rem; color: var(--text-dim);">Snapshots only</span>
                    </label>
                </form>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="header-action-icon" onclick="exportToCSV('vms')" title="Export filtered VMs to CSV">
                    <i data-lucide="download" size="18"></i>
                </div>
                <div id="vms-toggle-icon"
                    style="transition: transform 0.3s ease; transform: rotate(180deg); cursor: pointer;"
                    onclick="toggleInventorySection('vms-content', 'vms-toggle-icon')">
                    <i data-lucide="chevron-down"></i>
                </div>
            </div>
        </div>

        <div id="vms-content" style="display: flex; height: 600px; border-top: none; min-height: 600px;">
            <!-- Left Side: VM List -->
            <div class="inventory-list-pane" id="vm-list-pane"
                style="flex: 1; border-right: 1px solid var(--border); overflow-y: auto; position: relative; transition: all 0.3s ease;">
                <div id="vm-list-target" hx-get="/api/inventory/vms" hx-include="#vm-filters"
                    hx-trigger="load, vcenter-refreshed[!window.isSearchFocused] from:body">
                    <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
                        <div class="spinner-small" style="margin-bottom: 1rem;"></div>
                        Loading virtual machines...
                    </div>
                </div>
            </div>

            <!-- Collapse Toggle Button -->
            <div class="pane-toggle-btn" onclick="togglePaneCollapse()" id="vm-pane-toggle" title="Toggle Sidebar">
                <i data-lucide="chevron-left" id="toggle-icon"></i>
            </div>

            <!-- Right Side: VM Details -->
            <div class="inventory-details-pane" id="vm-details-panel"
                style="flex: 1.2; background: rgba(0,0,0,0.1); overflow-y: auto; transition: all 0.3s ease;">
                <div
                    style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); padding: 2rem; text-align: center;">
                    <i data-lucide="info" size="48" style="margin-bottom: 1rem; opacity: 0.2;"></i>
                    <p>Select a virtual machine to view detailed information, networks, and snapshots.</p>
                </div>
            </div>
        </div>
        <!-- Horizontal Resizer -->
        <div id="vms-resizer" class="horizontal-resizer" title="Drag down to expand VM list">
            <div class="resizer-handle-h"></div>
        </div>
    </section>

    <!-- Global Snapshots Section -->
    <section class="table-container" id="snapshots-section" style="margin-bottom: 1rem;">
        <div
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;"
                    onclick="toggleInventorySection('snapshots-content', 'snapshots-toggle-icon')">
                    <i data-lucide="camera" size="18" style="color: var(--accent);"></i> Global Snapshots
                    <span id="snap-count-badge" class="badge-accent" style="margin-left: 0.5rem;">{{ snap_count or 0
                        }}</span>
                </h2>

                <!-- Snapshot Filters -->
                <form id="snap-filters" style="display: flex; align-items: center; gap: 1rem;"
                    hx-get="/api/inventory/snapshots" hx-target="#snapshots-list-target" hx-trigger="change">
                    <label
                        style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;">
                        <div class="switch">
                            <input type="checkbox" name="today_only" value="true" hx-trigger="change">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size: 0.85rem; color: var(--text-dim);">Taken today</span>
                    </label>

                    <div style="width: 1px; height: 24px; background: var(--border); margin: 0 0.5rem;"></div>

                    <!-- Privileged Delete Action -->
                    <div
                        style="background: rgba(239, 68, 68, 0.06); border: 1px solid rgba(239, 68, 68, 0.15); padding: 0.3rem 0.6rem; border-radius: 6px; display: flex; align-items: center; gap: 0.75rem; width: fit-content;">
                        <i data-lucide="{{ 'shield-check' if elevated_unlocked else 'shield-alert' }}" size="14"
                            style="color: {{ 'var(--success)' if elevated_unlocked else 'var(--danger)' }}; opacity: 0.8;"
                            title="{{ 'Elevated Privileges Unlocked' if elevated_unlocked else 'Elevated Privileges Locked - go to Settings to unlock' }}"></i>

                        <button type="button" class="btn-primary" id="btn-delete-selected-snaps"
                            title="{% if not elevated_unlocked %}Requires elevated privileges{% else %}Delete selected snapshots{% endif %}"
                            style="{% if not elevated_unlocked %}opacity: 0.5; cursor: not-allowed;{% endif %} display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: var(--danger); border: none; color: white; border-radius: 4px; font-size: 0.85rem;"
                            {% if not elevated_unlocked %}disabled{% endif %} onclick="deleteSelectedGlobalSnapshots()">
                            <i data-lucide="trash-2" size="14"></i> Delete Selected
                        </button>
                    </div>
                </form>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="header-action-icon" id="btn-refresh-snapshots" onclick="refreshSnapshots()"
                    title="Refresh snapshots list">
                    <i data-lucide="refresh-cw" size="18" id="refresh-snap-icon"></i>
                </div>
                <div class="header-action-icon" onclick="exportToCSV('snapshots')"
                    title="Export filtered snapshots to CSV">
                    <i data-lucide="download" size="18"></i>
                </div>
                <div id="snapshots-toggle-icon" style="transition: transform 0.3s ease; cursor: pointer;"
                    onclick="toggleInventorySection('snapshots-content', 'snapshots-toggle-icon')">
                    <i data-lucide="chevron-down"></i>
                </div>
            </div>
        </div>
        <div id="snapshots-content" style="display: none; height: 400px; overflow-y: auto;"
            hx-get="/api/inventory/snapshots" hx-trigger="load" hx-target="#snapshots-list-target">
            <div id="snapshots-list-target">
                <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
                    <div class="spinner-small" style="margin-bottom: 1rem;"></div>
                    Loading global snapshots...
                </div>
            </div>
        </div>
    </section>

    <!-- Hosts Section -->
    <section class="table-container" id="hosts-section" style="margin-bottom: 1rem;">
        <div onclick="toggleInventorySection('hosts-content', 'hosts-toggle-icon')"
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; background: rgba(255,255,255,0.02);">
            <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                <i data-lucide="server" size="18" style="color: var(--warning);"></i> ESXi Hosts
            </h2>
            <div id="hosts-toggle-icon" style="transition: transform 0.3s ease;">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
        <div id="hosts-content" style="display: none; height: 500px;">
            <!-- Left Side: Host List -->
            <div class="inventory-list-pane" style="flex: 1; border-right: 1px solid var(--border); overflow-y: auto;"
                hx-get="/api/inventory/hosts" hx-trigger="load" hx-target="#host-list-target">
                <div id="host-list-target">
                    <div style="padding: 2rem; text-align: center; color: var(--text-dim);">Loading hosts...</div>
                </div>
            </div>

            <!-- Right Side: Host Details -->
            <div class="inventory-details-pane" id="host-details-panel"
                style="flex: 1.2; background: rgba(0,0,0,0.1); overflow-y: auto;">
                <div
                    style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); padding: 2rem; text-align: center;">
                    <i data-lucide="server" size="48" style="margin-bottom: 1rem; opacity: 0.2;"></i>
                    <p>Select an ESXi host to view hardware, version, and performance details.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Storage Section -->
    <section class="table-container" id="storage-section" style="margin-bottom: 2rem;">
        <div
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
            <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
                <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;"
                    onclick="toggleInventorySection('storage-content', 'storage-toggle-icon')">
                    <i data-lucide="database" size="18" style="color: var(--accent);"></i> Storage
                </h2>

                <!-- Storage Search Bar -->
                <div style="position: relative; width: 300px;">
                    <i data-lucide="search" size="14"
                        style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                    <input type="text" id="storage-search" placeholder="Filter by name or host..."
                        onkeyup="if(typeof filterStorage === 'function') filterStorage(this.value)"
                        style="width: 100%; background: var(--bg-main); border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem 1rem 0.4rem 2.25rem; font-size: 0.85rem; color: var(--text-main);">
                </div>
            </div>

            <div id="storage-toggle-icon" style="transition: transform 0.3s ease; cursor: pointer;"
                onclick="toggleInventorySection('storage-content', 'storage-toggle-icon')">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
        <div id="storage-content" style="display: none; padding: 1.5rem; max-height: 800px; overflow-y: auto;"
            hx-get="/api/inventory/storage" hx-trigger="load">
            <div style="padding: 2rem; text-align: center; color: var(--text-dim);">
                <div class="spinner-small" style="margin-bottom: 1rem;"></div>
                Loading storage topology...
            </div>
        </div>
    </section>

    <!-- Networking Topology Section -->
    <section class="table-container" id="networking-section" style="margin-bottom: 2rem;">
        <div
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
            <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
                <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none;"
                    onclick="toggleInventorySection('networking-content', 'networking-toggle-icon')">
                    <i data-lucide="network" size="18" style="color: var(--primary);"></i> Networking
                </h2>

                <!-- VLAN Search Bar -->
                <div style="position: relative; width: 300px;">
                    <i data-lucide="search" size="14"
                        style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim);"></i>
                    <input type="text" id="net-vlan-search" placeholder="Filter by VLAN ID or PG name..."
                        onkeyup="if(typeof filterNetByVlan === 'function') filterNetByVlan(this.value)"
                        style="width: 100%; background: var(--bg-main); border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem 1rem 0.4rem 2.25rem; font-size: 0.85rem; color: var(--text-main);">
                </div>
            </div>

            <div id="networking-toggle-icon" style="transition: transform 0.3s ease; cursor: pointer;"
                onclick="toggleInventorySection('networking-content', 'networking-toggle-icon')">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
        <!-- Removed hx-trigger="vcenter-refreshed from:body" to prevent resetting state -->
        <div id="networking-content" style="display: none; padding: 1.5rem; max-height: 800px; overflow-y: auto;"
            hx-get="/api/inventory/networks" hx-trigger="load">
            <div style="padding: 2rem; text-align: center; color: var(--text-dim);">
                <div class="spinner-small" style="margin-bottom: 1rem;"></div>
                Loading networking topology...
            </div>
        </div>
    </section>


    <!-- vCenter Management Section -->
    <section class="table-container" id="vcenters-section" style="margin-bottom: 2rem;">
        <div onclick="toggleInventorySection('vcenters-content', 'vcenters-toggle-icon')"
            style="padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; background: rgba(255,255,255,0.02);">
            <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                <i data-lucide="shield" size="18" style="color: var(--primary);"></i> Connected vCenter Servers
            </h2>
            <div id="vcenters-toggle-icon" style="transition: transform 0.3s ease;">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
        <div id="vcenters-content" style="display: none; height: auto; max-height: 400px; overflow-y: auto;"
            hx-get="/api/inventory/vcenters" hx-trigger="load" hx-target="#vcenters-list-target">
            <div id="vcenters-list-target">
                <div style="padding: 2rem; text-align: center; color: var(--text-dim);">Loading vCenter details...</div>
            </div>
        </div>
    </section>
</div>

<style>
    .inventory-list-table tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    .header-action-icon {
        cursor: pointer;
        color: var(--text-dim);
        transition: all 0.2s ease;
        padding: 5px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .header-action-icon:hover {
        color: var(--primary);
        background: rgba(var(--primary-rgb), 0.1);
    }

    .inventory-list-table tr:hover {
        background: rgba(var(--primary-rgb), 0.05) !important;
    }

    .inventory-list-table tr.selected {
        background: rgba(var(--primary-rgb), 0.15) !important;
        border-left: 3px solid var(--primary);
    }

    .detail-section {
        margin-bottom: 2rem;
    }

    .detail-section h4 {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-dim);
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .info-item label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-dim);
        margin-bottom: 0.25rem;
    }

    .info-item span {
        font-weight: 500;
        font-size: 0.935rem;
    }

    /* vCenter specific soft coloring */
    .vc-color-0 {
        background: rgba(59, 130, 246, 0.04) !important;
    }

    /* Blue */
    .vc-color-1 {
        background: rgba(16, 185, 129, 0.04) !important;
    }

    /* Green */
    .vc-color-2 {
        background: rgba(139, 92, 246, 0.04) !important;
    }

    /* Purple */
    .vc-color-3 {
        background: rgba(245, 158, 11, 0.04) !important;
    }

    /* Orange */
    .vc-color-4 {
        background: rgba(236, 72, 153, 0.04) !important;
    }

    /* Pink */

    .vc-color-0:hover {
        background: rgba(59, 130, 246, 0.1) !important;
    }

    .vc-color-1:hover {
        background: rgba(16, 185, 129, 0.1) !important;
    }

    .vc-color-2:hover {
        background: rgba(139, 92, 246, 0.1) !important;
    }

    .vc-color-3:hover {
        background: rgba(245, 158, 11, 0.1) !important;
    }

    .vc-color-4:hover {
        background: rgba(236, 72, 153, 0.1) !important;
    }

    .spinner-small {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    .refresh-spinner.htmx-request {
        animation: spin 1s linear infinite;
    }

    /* Pane Toggle Button Style */
    .pane-toggle-btn {
        width: 32px;
        height: 32px;
        background: #ffffff !important;
        border: 1px solid var(--border);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        margin-left: -16px;
        margin-right: -16px;
        z-index: 100;
        top: 25px;
        /* Positioned near the header */
        color: #1e293b;
        /* Dark icon */
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .pane-toggle-btn:hover {
        color: var(--primary);
        border-color: var(--primary);
        transform: scale(1.1);
    }

    /* Collapse states */
    #vm-list-pane.is-collapsed {
        flex: 0 0 250px !important;
    }

    #vm-list-pane.is-collapsed .hidable {
        display: none !important;
    }

    #vm-list-pane.is-collapsed th {
        width: 100% !important;
    }

    /* Horizontal Resizer */
    .horizontal-resizer {
        height: 10px;
        background: transparent;
        cursor: row-resize;
        display: flex;
        align-items: center;
        justify-content: center;
        border-top: 1px solid var(--border);
        transition: all 0.2s;
        user-select: none;
    }

    .horizontal-resizer:hover {
        background: rgba(var(--primary-rgb), 0.05);
    }

    .horizontal-resizer.is-resizing {
        background: rgba(var(--primary-rgb), 0.1) !important;
    }

    .resizer-handle-h {
        width: 48px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        transition: all 0.2s;
    }

    .horizontal-resizer:hover .resizer-handle-h {
        width: 64px;
        background: var(--primary);
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    function toggleInventorySection(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);

        if (content.style.display === 'none') {
            content.style.display = (contentId === 'vms-content' || contentId === 'hosts-content') ? 'flex' : 'block';
            icon.style.transform = 'rotate(180deg)';

            // Proactively check appliance statuses if showing vCenters
            if (contentId === 'vcenters-content' && typeof refreshAllApplianceStatuses === 'function') {
                refreshAllApplianceStatuses();
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    // Handle selection highlighting
    document.addEventListener('click', function (e) {
        const vmRow = e.target.closest('.vm-row');
        if (vmRow) {
            document.querySelectorAll('.vm-row').forEach(r => r.classList.remove('selected'));
            vmRow.classList.add('selected');

            // Sync hidden inputs for refresh preservation
            document.getElementById('selected-vm-id').value = vmRow.getAttribute('data-vm-id');
            document.getElementById('selected-vcenter-id').value = vmRow.getAttribute('data-vcenter-id');
        }
        const hostRow = e.target.closest('.host-row');
        if (hostRow) {
            document.querySelectorAll('.host-row').forEach(r => r.classList.remove('selected'));
            hostRow.classList.add('selected');
        }
    });

    // Handle clear search
    const searchInput = document.getElementById('vm-search');
    const clearBtn = document.getElementById('clear-search');

    searchInput.addEventListener('input', function () {
        clearBtn.style.display = this.value ? 'block' : 'none';
    });

    function clearVmSearch() {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        // Manually trigger HTMX update
        htmx.trigger('#vm-search', 'keyup');
    }

    function syncVmSelection(vcenterId, vmId) {
        // Remove selection from ALL rows in both lists
        document.querySelectorAll('.vm-row').forEach(r => r.classList.remove('selected'));

        // Find the specific VM row in the Virtual Machines list
        const vmRow = document.querySelector(`.inventory-list-pane tr[data-vm-id="${vmId}"][data-vcenter-id="${vcenterId}"]`);
        if (vmRow) {
            vmRow.classList.add('selected');
            // Scroll into view if not visible
            vmRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function exportToCSV(type) {
        let url = `/api/inventory/export/${type}`;

        // Append current filters for VMs
        if (type === 'vms') {
            const form = document.getElementById('vm-filters');
            if (form) {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                url += '?' + params.toString();
            }
        }

        // Append current filters for Snapshots
        if (type === 'snapshots') {
            const form = document.getElementById('snap-filters');
            if (form) {
                const formData = new FormData(form);
                const params = new URLSearchParams(formData);
                url += '?' + params.toString();
            }
        }

        // Trigger download
        const icon = event.currentTarget;
        const originalHTML = icon.innerHTML;
        icon.style.opacity = '0.5';
        icon.style.pointerEvents = 'none';

        window.location.href = url;

        // Restore icon after a short delay (standard browser behavior handles the "background" part)
        setTimeout(() => {
            icon.style.opacity = '1';
            icon.style.pointerEvents = 'auto';
        }, 2000);
    }

    function togglePaneCollapse() {
        const pane = document.getElementById('vm-list-pane');
        const details = document.getElementById('vm-details-panel');
        const icon = document.getElementById('toggle-icon');

        const isCollapsed = pane.classList.toggle('is-collapsed');

        if (isCollapsed) {
            details.style.flex = "2";
            icon.setAttribute('data-lucide', 'chevron-right');
        } else {
            details.style.flex = "1.2";
            icon.setAttribute('data-lucide', 'chevron-left');
        }

        // Re-render Lucide icons
        if (window.lucide) {
            lucide.createIcons();
        }
    }

    // VM Panel Resizing Logic
    function initInventoryResizers() {
        const resizer = document.getElementById('vms-resizer');
        const content = document.getElementById('vms-content');

        if (!resizer || !content) return;

        // Load saved height
        const savedHeight = localStorage.getItem('vms-panel-height');
        if (savedHeight) {
            content.style.height = savedHeight + 'px';
        }

        let startY, startHeight;

        resizer.addEventListener('mousedown', function (e) {
            startY = e.clientY;
            startHeight = parseInt(document.defaultView.getComputedStyle(content).height, 10);
            resizer.classList.add('is-resizing');

            // Global overlay classes or just use document events
            document.body.style.cursor = 'row-resize';

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);

            e.preventDefault();
        });

        function onMouseMove(e) {
            const delta = e.clientY - startY;
            const newHeight = Math.max(600, startHeight + delta); // Min height 600
            content.style.height = newHeight + 'px';
        }

        function onMouseUp() {
            resizer.classList.remove('is-resizing');
            document.body.style.cursor = 'default';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);

            // Save preferred height
            localStorage.setItem('vms-panel-height', parseInt(content.style.height));
        }
    }

    // Snapshot Deletion Logic
    let activeTaskCount = 0;

    function refreshInventoryPanels() {
        // Refresh snapshots table
        const snapFilters = document.getElementById('snap-filters');
        if (snapFilters) htmx.trigger(snapFilters, 'change');

        // Refresh details pane if a VM is selected
        const selectedVmId = document.getElementById('selected-vm-id')?.value;
        const selectedVcId = document.getElementById('selected-vcenter-id')?.value;

        if (selectedVmId && selectedVcId) {
            const url = `/api/inventory/vm-details/${selectedVcId}/${selectedVmId}`;
            const detailsPanel = document.getElementById('vm-details-panel');
            if (detailsPanel) {
                htmx.ajax('GET', url, { target: '#vm-details-panel', select: '#vm-details-panel' });
            }
        }
    }

    function updateSnapshotIconsState(vcenterId, vmId, snapshotName, isDeleting) {
        // Find all buttons that match this snapshot in both panels
        const selector = `button[onclick*="'${vcenterId}'"][onclick*="'${vmId}'"][onclick*="'${snapshotName}'"]`;
        const buttons = document.querySelectorAll(selector);
        buttons.forEach(btn => {
            if (isDeleting) {
                btn.innerHTML = '<div class="spinner-small" style="width: 14px; height: 14px; border-width: 1px;"></div>';
                btn.disabled = true;
                btn.classList.add('is-deleting');
            } else {
                btn.innerHTML = '<i data-lucide="trash-2" size="16"></i>';
                btn.disabled = false;
                btn.classList.remove('is-deleting');
                if (window.lucide) lucide.createIcons();
            }
        });
    }

    async function monitorTask(vcenterId, taskId, snapshotName, vmId) {
        activeTaskCount++;
        const interval = setInterval(async () => {
            try {
                const r = await fetch(`/api/inventory/tasks/${vcenterId}/${taskId}`);
                const data = await r.json();
                if (data.success) {
                    const status = data.status;
                    // states: 'queued', 'running', 'success', 'error'
                    if (status.state === 'success' || status.state === 'error') {
                        clearInterval(interval);
                        activeTaskCount--;

                        if (status.state === 'success') {
                            showToast(`Snapshot '${snapshotName}' deleted successfully.`, 'success');
                            // We don't restore the icon if success, the refresh will handle it
                        } else {
                            showToast(`Error deleting '${snapshotName}': ${status.error}`, 'error');
                            // Restore icons only on error
                            updateSnapshotIconsState(vcenterId, vmId, snapshotName, false);
                        }

                        if (activeTaskCount === 0) {
                            setTimeout(refreshInventoryPanels, 1000);
                        }
                    }
                } else {
                    // API failure - stop monitoring to avoid infinite loop
                    clearInterval(interval);
                    activeTaskCount--;
                    updateSnapshotIconsState(vcenterId, vmId, snapshotName, false);
                }
            } catch (e) {
                console.error("Task check failed:", e);
                clearInterval(interval);
                activeTaskCount--;
                updateSnapshotIconsState(vcenterId, vmId, snapshotName, false);
            }
        }, 5000);
    }

    function toggleAllSnapshots(source) {
        const checkboxes = document.querySelectorAll('.snapshot-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
        });
        updateSnapshotDeleteState();
    }

    function updateSnapshotDeleteState() {
        const checkboxes = document.querySelectorAll('.snapshot-checkbox:checked');
        const count = checkboxes.length;
        const btnTitle = document.getElementById('btn-delete-selected-snaps');
        if (btnTitle) {
            btnTitle.innerHTML = `<i data-lucide="trash-2" size="14"></i> Delete Selected (${count})`;
            if (window.lucide) lucide.createIcons();
        }
    }

    async function deleteSnapshot(vcenterId, vmId, snapshotName, btnElem) {
        if (!confirm(`Are you sure you want to delete snapshot '${snapshotName}'?`)) return;

        updateSnapshotIconsState(vcenterId, vmId, snapshotName, true);

        try {
            const res = await fetch('/api/inventory/snapshots/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vcenter_id: vcenterId,
                    vm_id: vmId,
                    snapshot_name: snapshotName
                })
            });

            const data = await res.json();
            if (data.success && data.task_id) {
                showToast(`Snapshot '${snapshotName}' deletion initiated.`, 'info');
                monitorTask(vcenterId, data.task_id, snapshotName, vmId);
            } else {
                showToast(data.error || 'Failed to delete snapshot', 'error');
                updateSnapshotIconsState(vcenterId, vmId, snapshotName, false);
            }
        } catch (error) {
            console.error('Error deleting snapshot:', error);
            showToast('Network error while deleting snapshot.', 'error');
            updateSnapshotIconsState(vcenterId, vmId, snapshotName, false);
        }
    }

    async function deleteSelectedGlobalSnapshots() {
        const checkboxes = document.querySelectorAll('.snapshot-checkbox:checked');
        const count = checkboxes.length;
        if (count === 0) {
            showToast('No snapshots selected.', 'warning');
            return;
        }

        if (!confirm(`Are you sure you want to delete ${count} selected snapshot(s)?`)) return;

        const btnTitle = document.getElementById('btn-delete-selected-snaps');
        const originalText = btnTitle.innerHTML;
        btnTitle.innerHTML = '<div class="spinner-small" style="width: 14px; height: 14px; border-width: 1px;"></div> Deleting...';
        btnTitle.disabled = true;

        const snapshotsToProcess = [];
        checkboxes.forEach(cb => {
            snapshotsToProcess.push({
                vcenter_id: cb.getAttribute('data-vcenter-id'),
                vm_id: cb.getAttribute('data-vm-id'),
                snapshot_name: cb.value
            });
        });

        try {
            const res = await fetch('/api/inventory/snapshots/delete-bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ snapshots: snapshotsToProcess })
            });

            const data = await res.json();
            if (data.success && data.results) {
                let startedCount = 0;
                data.results.forEach(resItem => {
                    if (resItem.success && resItem.task_id) {
                        startedCount++;
                        updateSnapshotIconsState(resItem.vcenter_id, resItem.vm_id, resItem.snapshot_name, true);
                        monitorTask(resItem.vcenter_id, resItem.task_id, resItem.snapshot_name, resItem.vm_id);
                    } else {
                        showToast(`Failed to initiate deletion for '${resItem.snapshot_name}'`, 'warning');
                    }
                });
                if (startedCount > 0) {
                    showToast(`Successfully initiated deletion of ${startedCount} snapshots.`, 'info');
                }
            } else {
                showToast(data.error || 'Failed to delete selected snapshots', 'error');
            }
        } catch (error) {
            console.error('Error deleting snapshots in bulk:', error);
            showToast('Network error while deleting snapshots.', 'error');
        } finally {
            btnTitle.innerHTML = originalText;
            btnTitle.disabled = false;
            if (window.lucide) lucide.createIcons();
            // Clear selections
            const selectAllCheck = document.getElementById('selectAllSnapshots');
            if (selectAllCheck) {
                selectAllCheck.checked = false;
                toggleAllSnapshots(selectAllCheck);
            }
        }
    }

    function refreshSnapshots() {
        const icon = document.getElementById('refresh-snap-icon');
        if (icon) {
            icon.style.animation = 'spin 0.8s linear infinite';
        }

        // Collect filter values from the form
        const form = document.getElementById('snap-filters');
        const todayOnly = form ? form.querySelector('[name="today_only"]')?.checked : false;
        const url = `/api/inventory/snapshots?today_only=${todayOnly ? 'true' : ''}`;

        htmx.ajax('GET', url, {
            target: '#snapshots-list-target',
            swap: 'innerHTML'
        }).then(() => {
            if (icon) icon.style.animation = '';
            if (window.lucide) lucide.createIcons();
        }).catch(() => {
            if (icon) icon.style.animation = '';
        });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        window.isSearchFocused = false;
        initInventoryResizers();
    });
</script>
{% endblock %}