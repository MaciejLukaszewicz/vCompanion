{% extends "base.html" %}

{% block title %}vCompanion - Dashboard{% endblock %}

{% block content %}
<header>
    <div>
        <h1>Global Overview</h1>
        <p style="color: var(--text-dim); font-size: 0.875rem;">
            Summary across {{ vcenter_count }} connected vCenter environment{{ 's' if vcenter_count != 1 else '' }}
        </p>
    </div>
</header>

<!-- Stats Grid -->
<section id="stats-container" class="stats-grid" hx-get="/api/vcenters/stats-cards"
    hx-trigger="vcenter-refreshed from:body, every 60s" hx-swap="innerHTML">
    {% include "partials/stats_grid.html" %}
</section>

<!-- Recent Tasks Table -->
<section class="table-container" style="margin-top: 2rem;" id="tasks-table-section">
    <div onclick="toggleTasks()"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="list-checks" size="18"></i> Recent Tasks (Last 30m)
        </h2>
        <div id="tasks-toggle-icon" style="transition: transform 0.3s ease;">
            <i data-lucide="chevron-down"></i>
        </div>
    </div>
    <div id="tasks-table-content" style="display: none;" hx-get="/api/dashboard/tasks-table"
        hx-trigger="load-tasks from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live tasks from vCenters...
        </div>
    </div>
</section>

<!-- Alerts Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="alerts-table-section">
    <div onclick="toggleAlerts()"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"
            id="alerts-header">
            <i data-lucide="bell" size="18"></i> Triggered Infrastructure Alarms
            <span id="alerts-count-badge">
                {% if alerts|length > 0 %}
                <span class="status-badge critical" style="padding: 2px 8px; font-size: 0.7rem; margin-left: 0.5rem;">{{
                    alerts|length }} ACTIVE</span>
                {% endif %}
            </span>
        </h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div onclick="event.stopPropagation(); htmx.trigger('#alerts-table-content', 'load-alerts');"
                title="Force refresh alarms"
                style="cursor: pointer; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                onmouseout="this.style.background='transparent'">
                <i data-lucide="refresh-cw" size="16" style="color: var(--text-dim);"></i>
            </div>
            <div id="alerts-toggle-icon" style="transition: transform 0.3s ease;">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
    </div>
    <div id="alerts-table-content" style="display: none;" hx-get="/api/dashboard/alerts-table"
        hx-trigger="load-alerts from:body, vcenter-refreshed from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live alarms...
        </div>
    </div>
</section>

<!-- Recent Events Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="events-table-section">
    <div onclick="toggleEvents()"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="activity" size="18"></i> Recent Events (Last 5m)
        </h2>
        <div id="events-toggle-icon" style="transition: transform 0.3s ease;">
            <i data-lucide="chevron-down"></i>
        </div>
    </div>
    <div id="events-table-content" style="display: none;" hx-get="/api/dashboard/events-table"
        hx-trigger="load-events from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live events from vCenters...
        </div>
    </div>
</section>

<style>
    .spinner-small {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    lucide.createIcons();

    function toggleSection(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);

        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleTasks() {
        const content = document.getElementById('tasks-table-content');
        const icon = document.getElementById('tasks-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-tasks");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleEvents() {
        const content = document.getElementById('events-table-content');
        const icon = document.getElementById('events-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-events");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleAlerts() {
        const content = document.getElementById('alerts-table-content');
        const icon = document.getElementById('alerts-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-alerts");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    lucide.createIcons();
</script>
{% endblock %}