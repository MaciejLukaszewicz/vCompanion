{% extends "base.html" %}

{% block title %}vCompanion - Dashboard{% endblock %}

{% block content %}
<header>
    <div>
        <h1>Global Overview</h1>
        <p style="color: var(--text-dim); font-size: 0.875rem;">
            Summary across {{ vcenter_count }} connected vCenter environment{{ 's' if vcenter_count != 1 else '' }}
        </p>
    </div>
    <div class="search-bar">
        <i data-lucide="search" size="18" style="color: var(--text-dim);"></i>
        <input type="text" placeholder="Search VMs, IPs, Hosts..." hx-get="/api/search"
            hx-trigger="keyup changed delay:500ms" hx-target="#search-results">
    </div>
</header>

<!-- Stats Grid -->
<section id="stats-container" class="stats-grid" hx-get="/api/vcenters/stats-cards"
    hx-trigger="vcenter-refreshed from:body, every 60s" hx-swap="innerHTML">
    {% include "partials/stats_grid.html" %}
</section>

<!-- Recent Tasks Table -->
<section class="table-container" style="margin-top: 2rem;" id="tasks-table-section">
    <div onclick="toggleTasks()"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="list-checks" size="18"></i> Recent Tasks (Last 30m)
        </h2>
        <div id="tasks-toggle-icon" style="transition: transform 0.3s ease;">
            <i data-lucide="chevron-down"></i>
        </div>
    </div>
    <div id="tasks-table-content" style="display: none;" hx-get="/api/dashboard/tasks-table"
        hx-trigger="load-tasks from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live tasks from vCenters...
        </div>
    </div>
</section>

<!-- Alerts Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="alerts-table-section">
    <div onclick="toggleSection('alerts-table-content', 'alerts-toggle-icon')"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="bell" size="18"></i> Triggered Infrastructure Alarms
            {% if alerts|length > 0 %}
            <span class="status-badge critical" style="padding: 2px 8px; font-size: 0.7rem; margin-left: 0.5rem;">{{
                alerts|length }} ACTIVE</span>
            {% endif %}
        </h2>
        <div id="alerts-toggle-icon" style="transition: transform 0.3s ease;">
            <i data-lucide="chevron-down"></i>
        </div>
    </div>
    <div id="alerts-table-content" style="display: none;">
        <table>
            <thead>
                <tr>
                    <th>Severity</th>
                    <th>Level</th>
                    <th>Alarm Name</th>
                    <th>Entity</th>
                    <th>vCenter</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                {% if alerts %}
                {% for alert in alerts %}
                <tr>
                    <td><span class="status-badge {{ alert.severity }}">{{ alert.severity | upper }}</span></td>
                    <td>
                        <div
                            style="display: flex; align-items: center; gap: 0.35rem; font-size: 0.75rem; color: var(--text-dim);">
                            <span
                                style="background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border);">{{
                                alert.entity_type }}</span>
                        </div>
                    </td>
                    <td style="font-weight: 500;">{{ alert.alarm_name }}</td>
                    <td>{{ alert.entity_name }}</td>
                    <td style="font-size: 0.8rem;">{{ alert.vcenter_name }}</td>
                    <td style="color: var(--text-dim); font-size: 0.75rem;">{{ alert.time }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--text-dim); padding: 4rem;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <i data-lucide="check-circle" size="32" style="color: var(--success);"></i>
                            <p>No active infrastructure alarms detected.</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</section>

<!-- Recent Events Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="events-table-section">
    <div onclick="toggleEvents()"
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="activity" size="18"></i> Recent Events (Last 30m)
        </h2>
        <div id="events-toggle-icon" style="transition: transform 0.3s ease;">
            <i data-lucide="chevron-down"></i>
        </div>
    </div>
    <div id="events-table-content" style="display: none;" hx-get="/api/dashboard/events-table"
        hx-trigger="load-events from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live events from vCenters...
        </div>
    </div>
</section>

<style>
    .spinner-small {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    lucide.createIcons();

    function toggleSection(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);

        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleTasks() {
        const content = document.getElementById('tasks-table-content');
        const icon = document.getElementById('tasks-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-tasks");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleEvents() {
        const content = document.getElementById('events-table-content');
        const icon = document.getElementById('events-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-events");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }
</script>
{% endblock %}