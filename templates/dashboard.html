{% extends "base.html" %}

{% block title %}vCompanion - Dashboard{% endblock %}

{% block content %}
<header>
    <div>
        <h1>Global Overview</h1>
        <p style="color: var(--text-dim); font-size: 0.875rem;">
            Summary across {{ vcenter_count }} connected vCenter environment{{ 's' if vcenter_count != 1 else '' }}
        </p>
    </div>
</header>

<!-- Stats Grid -->
<section id="stats-container" class="stats-grid" hx-get="/api/vcenters/stats-cards"
    hx-trigger="vcenter-refreshed from:body, every 60s" hx-swap="innerHTML">
    {% include "partials/stats_grid.html" %}
</section>

<!-- Recent Tasks Table -->
<section class="table-container" style="margin-top: 2rem;" id="tasks-table-section">
    <div onclick="toggleTasks()"
        style="padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="list-checks" size="18"></i> Recent Tasks (Last 30m)
        </h2>
        <div style="display: flex; gap: 1.5rem; align-items: center;">
            <div class="toggle-group" onclick="event.stopPropagation()">
                <label class="toggle-item">
                    <span>Autorefresh</span>
                    <div class="switch">
                        <input type="checkbox" id="tasks-autorefresh" onchange="handleTasksConfigChange()" checked>
                        <span class="slider"></span>
                    </div>
                </label>
                <label class="toggle-item">
                    <span>Active only</span>
                    <div class="switch">
                        <input type="checkbox" id="tasks-active-only" onchange="handleTasksConfigChange()">
                        <span class="slider"></span>
                    </div>
                </label>
            </div>
            <div id="tasks-toggle-icon" style="transition: transform 0.3s ease; transform: rotate(180deg);">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
    </div>
    <div id="tasks-table-content" style="display: block;" hx-get="/api/dashboard/tasks-table"
        hx-trigger="load-tasks from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live tasks from vCenters...
        </div>
    </div>
</section>

<!-- Alerts Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="alerts-table-section">
    <div onclick="toggleAlerts()"
        style="padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;"
            id="alerts-header">
            <i data-lucide="bell" size="18"></i> Triggered Infrastructure Alarms
            <span id="alerts-count-badge">
                {% if alerts|length > 0 %}
                <span class="status-badge critical" style="padding: 2px 8px; font-size: 0.7rem; margin-left: 0.5rem;">{{
                    alerts|length }} ACTIVE</span>
                {% endif %}
            </span>
        </h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div onclick="event.stopPropagation(); htmx.trigger('body', 'load-alerts');" title="Force refresh alarms"
                style="cursor: pointer; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                onmouseout="this.style.background='transparent'">
                <i data-lucide="refresh-cw" size="16" style="color: var(--text-dim);"></i>
            </div>
            <div id="alerts-toggle-icon" style="transition: transform 0.3s ease;">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
    </div>
    <div id="alerts-table-content" style="display: none;" hx-get="/api/dashboard/alerts-table"
        hx-trigger="load-alerts from:body, vcenter-refreshed from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live alarms...
        </div>
    </div>
</section>

<!-- Recent Events Table -->
<section class="table-container" style="margin-top: 1.5rem;" id="events-table-section">
    <div onclick="toggleEvents()"
        style="padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
        <h2 style="font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="activity" size="18"></i> Recent Events (Last 5m)
        </h2>
        <div style="display: flex; gap: 1.5rem; align-items: center;">
            <div class="toggle-group" onclick="event.stopPropagation()">
                <label class="toggle-item">
                    <span>Filter out logon and logoff events</span>
                    <div class="switch">
                        <input type="checkbox" id="events-filter-logon" checked onchange="handleEventsConfigChange()">
                        <span class="slider"></span>
                    </div>
                </label>
            </div>
            <div id="events-toggle-icon" style="transition: transform 0.3s ease;">
                <i data-lucide="chevron-down"></i>
            </div>
        </div>
    </div>
    <div id="events-table-content" style="display: none;" hx-get="/api/dashboard/events-table"
        hx-trigger="load-events from:body" hx-swap="innerHTML">
        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">
            <div class="spinner-small" style="margin-bottom: 1rem;"></div>
            Fetching live events from vCenters...
        </div>
    </div>
</section>

<style>
    .spinner-small {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    lucide.createIcons();

    let tasksRefreshInterval = null;

    function handleTasksConfigChange() {
        const activeOnly = document.getElementById('tasks-active-only').checked;
        const autorefresh = document.getElementById('tasks-autorefresh').checked;

        const content = document.getElementById('tasks-table-content');
        content.setAttribute('hx-get', `/api/dashboard/tasks-table?active_only=${activeOnly}`);
        htmx.process(content);

        if (content.style.display !== 'none') {
            htmx.trigger(document.body, "load-tasks");
        }

        if (autorefresh && content.style.display !== 'none') {
            startTasksAutorefresh();
        } else {
            stopTasksAutorefresh();
        }
    }

    function startTasksAutorefresh() {
        if (tasksRefreshInterval) return;
        tasksRefreshInterval = setInterval(() => {
            const content = document.getElementById('tasks-table-content');
            if (content.style.display !== 'none') {
                htmx.trigger(document.body, "load-tasks");
            }
        }, 10000);
    }

    function stopTasksAutorefresh() {
        if (tasksRefreshInterval) {
            clearInterval(tasksRefreshInterval);
            tasksRefreshInterval = null;
        }
    }

    function handleEventsConfigChange() {
        const filterLogon = document.getElementById('events-filter-logon').checked;
        const content = document.getElementById('events-table-content');
        content.setAttribute('hx-get', `/api/dashboard/events-table?filter_logon=${filterLogon}`);
        htmx.process(content);

        if (content.style.display !== 'none') {
            htmx.trigger(document.body, "load-events");
        }
    }

    function toggleTasks() {
        const content = document.getElementById('tasks-table-content');
        const icon = document.getElementById('tasks-toggle-icon');
        const autorefresh = document.getElementById('tasks-autorefresh').checked;

        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                // First load
                handleTasksConfigChange();
            } else if (autorefresh) {
                startTasksAutorefresh();
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
            stopTasksAutorefresh();
        }
    }

    function toggleEvents() {
        const content = document.getElementById('events-table-content');
        const icon = document.getElementById('events-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                handleEventsConfigChange();
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function toggleAlerts() {
        const content = document.getElementById('alerts-table-content');
        const icon = document.getElementById('alerts-toggle-icon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            if (content.innerHTML.includes('spinner-small')) {
                htmx.trigger("body", "load-alerts");
            }
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    lucide.createIcons();
    // Initialize open panels
    handleTasksConfigChange();
</script>
{% endblock %}